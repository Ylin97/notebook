# æ™ºèƒ½æŒ‡é’ˆ

## weak_ptr

`std::weak_ptr` æ˜¯ C++ æ™ºèƒ½æŒ‡é’ˆå®¶æ—ä¸­çš„â€œè§‚å¯Ÿè€…â€ï¼Œå®ƒ**ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸æ‹¥æœ‰å¯¹è±¡çš„æ‰€æœ‰æƒ**ï¼Œè€Œæ˜¯**å¼±å¼•ç”¨ï¼ˆweak referenceï¼‰ä¸€ä¸ªç”± `shared_ptr` ç®¡ç†çš„å¯¹è±¡**ã€‚

å®ƒçš„ä¸»è¦ç”¨é€”æ˜¯ï¼š

---

### âœ… 1. **æ‰“ç ´ `shared_ptr` çš„å¾ªç¯å¼•ç”¨ï¼ˆCircular Referenceï¼‰**
è¿™æ˜¯ `weak_ptr` æœ€é‡è¦ã€æœ€ç»å…¸çš„ä½¿ç”¨åœºæ™¯ã€‚

#### âŒ é—®é¢˜ï¼šå¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼
```cpp
struct Node {
    shared_ptr<Node> parent;
    shared_ptr<Node> child;
};

int main() {
    auto node1 = make_shared<Node>();
    auto node2 = make_shared<Node>();
    node1->child = node2;
    node2->parent = node1; // å¾ªç¯å¼•ç”¨ï¼
}
```
- `node1` å¼•ç”¨ `node2`ï¼ˆå¼•ç”¨è®¡æ•°=1ï¼‰
- `node2` å¼•ç”¨ `node1`ï¼ˆå¼•ç”¨è®¡æ•°=1ï¼‰
- å³ä½¿ `node1` å’Œ `node2` è¶…å‡ºä½œç”¨åŸŸï¼Œå¼•ç”¨è®¡æ•°ä¹Ÿä¸ä¼šå½’é›¶ï¼Œå†…å­˜æ— æ³•é‡Šæ”¾ï¼

#### âœ… è§£å†³æ–¹æ¡ˆï¼šç”¨ `weak_ptr` æ‰“ç ´å¾ªç¯
```cpp
struct Node {
    shared_ptr<Node> child;
    weak_ptr<Node> parent; // æ”¹ä¸º weak_ptr
};
```
ç°åœ¨ `parent` ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¾ªç¯è¢«æ‰“ç ´ï¼Œå¯¹è±¡å¯ä»¥æ­£ç¡®ææ„ã€‚

> ğŸ“Œ **å…¸å‹åœºæ™¯**ï¼šæ ‘ç»“æ„ä¸­çš„çˆ¶å­å…³ç³»ã€åŒå‘é“¾è¡¨ã€è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆå¦‚ä½ ä¹‹å‰çš„ä¾‹å­ï¼‰ã€‚

---

### âœ… 2. **ç¼“å­˜ï¼ˆCacheï¼‰æˆ–èµ„æºæ± **
å½“ä½ æƒ³ç¼“å­˜ä¸€äº›å¯¹è±¡ï¼Œä½†åˆä¸å¸Œæœ›ç¼“å­˜æœ¬èº«é˜»æ­¢å¯¹è±¡è¢«é”€æ¯ã€‚

```cpp
class ObjectCache {
    unordered_map<string, weak_ptr<MyObject>> cache;
public:
    shared_ptr<MyObject> get(const string& key) {
        auto it = cache.find(key);
        if (it != cache.end()) {
            if (auto obj = it->second.lock()) { // å°è¯•æå‡ä¸º shared_ptr
                return obj; // å¯¹è±¡è¿˜æ´»ç€ï¼Œè¿”å›å…±äº«å¼•ç”¨
            }
        }
        // å¯¹è±¡å·²é”€æ¯ï¼Œé‡æ–°åˆ›å»º
        auto newObj = make_shared<MyObject>(key);
        cache[key] = newObj;
        return newObj;
    }
};
```
- `weak_ptr` å…è®¸å¯¹è±¡åœ¨æ— äººä½¿ç”¨æ—¶è‡ªåŠ¨é”€æ¯ã€‚
- ä¸‹æ¬¡è®¿é—®æ—¶å¦‚æœå¯¹è±¡è¿˜åœ¨ï¼Œå°±å¤ç”¨ï¼›å¦åˆ™é‡å»ºã€‚

> ğŸ“Œ **å…¸å‹åœºæ™¯**ï¼šæ•°æ®åº“è¿æ¥æ± ã€å›¾åƒç¼“å­˜ã€å­—ç¬¦ä¸²é©»ç•™ç­‰ã€‚

---

### âœ… 3. **è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„â€œè§‚å¯Ÿè€…â€å¯¹â€œè¢«è§‚å¯Ÿè€…â€çš„å¼•ç”¨**
æ­£å¦‚ä½ ä¹‹å‰çš„ä¾‹å­ï¼š

```cpp
class Observer {
    weak_ptr<Subject> subject; // è§‚å¯Ÿè€…ä¸åº”å»¶é•¿è¢«è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸ
public:
    void update() {
        if (auto s = subject.lock()) {
            cout << "Subject action: " << s->action << endl;
        }
    }
};
```
- è¢«è§‚å¯Ÿè€…ï¼ˆSubjectï¼‰ç®¡ç†è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸã€‚
- è§‚å¯Ÿè€…åªæ˜¯â€œç›‘å¬â€ï¼Œä¸åº”é˜»æ­¢ Subject è¢«é”€æ¯ã€‚

---

### âœ… 4. **é¿å…æ‚¬ç©ºæŒ‡é’ˆçš„â€œå®‰å…¨è£¸æŒ‡é’ˆâ€æ›¿ä»£**
`weak_ptr` å¯ä»¥çœ‹ä½œæ˜¯æ¯”è£¸æŒ‡é’ˆæ›´å®‰å…¨çš„â€œä¸´æ—¶å¼•ç”¨â€ã€‚

```cpp
weak_ptr<Data> globalRef;

void setRef(shared_ptr<Data> data) {
    globalRef = data;
}

void useRef() {
    if (auto p = globalRef.lock()) { // å®‰å…¨æ£€æŸ¥
        p->process();
    } else {
        cout << "Data has been destroyed." << endl;
    }
}
```
ç›¸æ¯”è£¸æŒ‡é’ˆï¼Œ`weak_ptr` å¯ä»¥æ£€æµ‹å¯¹è±¡æ˜¯å¦è¿˜å­˜åœ¨ã€‚

---

### âœ… 5. **å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰æˆ–å•ä¾‹çš„çº¿ç¨‹å®‰å…¨å®ç°**
ç»“åˆ `shared_ptr` å’Œ `weak_ptr` å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹ç¼“å­˜ï¼š

```cpp
static weak_ptr<MySingleton> cache;

shared_ptr<MySingleton> getInstance() {
    if (auto ptr = cache.lock()) {
        return ptr;
    }
    auto newPtr = make_shared<MySingleton>();
    cache = newPtr;
    return newPtr;
}
```

---

### âš ï¸ ä½¿ç”¨ `weak_ptr` çš„æ³¨æ„äº‹é¡¹

1. **ä¸èƒ½ç›´æ¥ä½¿ç”¨**ï¼šå¿…é¡»é€šè¿‡ `.lock()` æå‡ä¸º `shared_ptr`ã€‚
2. **`.lock()` è¿”å› `shared_ptr<T>`**ï¼šå¦‚æœåŸå¯¹è±¡å·²é”€æ¯ï¼Œè¿”å›ç©º `shared_ptr`ã€‚
3. **æ€§èƒ½å¼€é”€**ï¼š`.lock()` éœ€è¦çº¿ç¨‹å®‰å…¨åœ°æ£€æŸ¥æ§åˆ¶å—ï¼Œæœ‰ä¸€å®šå¼€é”€ã€‚
4. **ä¸è¦é•¿æœŸæŒæœ‰ `lock()` çš„ç»“æœ**ï¼šé¿å…ä¸å¿…è¦çš„å¼•ç”¨è®¡æ•°å¢åŠ ã€‚

---

### æ€»ç»“ï¼šå»ºè®®ä½¿ç”¨ `weak_ptr` çš„åœºæ™¯

| åœºæ™¯                        | è¯´æ˜                           |
| --------------------------- | ------------------------------ |
| ğŸ” **æ‰“ç ´å¾ªç¯å¼•ç”¨**          | æ ‘å½¢ç»“æ„ã€åŒå‘å…³è”ã€è§‚å¯Ÿè€…æ¨¡å¼ |
| ğŸ§  **ç¼“å­˜ / èµ„æºæ± **         | å¸Œæœ›å¯¹è±¡åœ¨æ— äººä½¿ç”¨æ—¶è‡ªåŠ¨é”€æ¯   |
| ğŸ‘€ **è§‚å¯Ÿè€…å¼•ç”¨è¢«è§‚å¯Ÿè€…**    | ä¸åº”å»¶é•¿è¢«è§‚å¯Ÿè€…ç”Ÿå‘½å‘¨æœŸ       |
| ğŸ›¡ï¸ **å®‰å…¨çš„ä¸´æ—¶å¼•ç”¨**        | æ›¿ä»£è£¸æŒ‡é’ˆï¼Œé¿å…æ‚¬ç©º           |
| ğŸ§© **å»¶è¿Ÿåˆå§‹åŒ– / å•ä¾‹ç¼“å­˜** | çº¿ç¨‹å®‰å…¨åœ°å¤ç”¨å¯¹è±¡             |

> ğŸ’¡ **å£è¯€**ï¼š**å½“ä½ éœ€è¦â€œçŸ¥é“ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨â€ï¼Œä½†åˆä¸æƒ³â€œå†³å®šå®ƒæ˜¯å¦å­˜æ´»â€æ—¶ï¼Œå°±ç”¨ `weak_ptr`ã€‚**

å®ƒæ˜¯ `shared_ptr` çš„å®Œç¾æ­æ¡£ï¼Œå¸®åŠ©ä½ åœ¨å…±äº«æ‰€æœ‰æƒçš„åŒæ—¶ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œé€»è¾‘é”™è¯¯ã€‚